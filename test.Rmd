---
title: "R Notebook"
output: html_document
---

Some important changes:

1.- Change Selective and non-selective plates.
2.- Try to generalize the use of only one Keyfile (screen Processing)
3.- Been able to change the median value for NSP and SP
4.- Been able to change the filter criteria.

```{r set, message=FALSE, warning=FALSE}
library(tidyverse)
```

```{r}
source("High_Replica_Pinning_Tools.R")
```

Another point to remember is that the key file nees to be in order Plate, Column and then Row

```{r}
df_lib <- read_csv("Data/Keyfile_YKO-PK_384_reformatted_DN.csv", show_col_types = FALSE, col_types = "c") %>% 
  drop_na(`Plate #`, Column, Row) %>% 
  arrange(`Plate #`, Column, Row)
plates_lib <- unique(df_lib$`Plate #`)
dim(df_lib)
head(df_lib)
tail(df_lib)
```

```{r}
## Correction and filling the Key file
  key_full <- df_lib %>% 
    group_by(`Plate #`) %>% 
    tally() %>% 
    distinct(n) %>% 
    min()
key_full
```

```{r}
cells <- 1536
if (key_full < 384) {
    cat("Coordinates in Key file incomplete. Proceeding to complete it.\n")
    ## New Database with old and new coordinates
    nrow_plate <- cells # CHANGE IF NECCESARY
    old_rows_plate <- rep(unique(df_lib$Row), each = 2, times = nrow_plate/length(rows_plate))
    old_cols_plate <- rep(unique(df_lib$Column), each = nrow_plate/length(columns_plate)*2) # Necessary multiply for the replicates, IN this case 2
    nplates <- length(plates_lib)
    
    df_lib <- tibble(
      "Plate #" = as.character(rep(1:nplates, each = nrow_plate)),
      "Row" = rep(old_rows_plate, times = nplates),
      "Column" = rep(old_cols_plate, times = nplates),
    )  %>%
      distinct() %>%
      left_join(df_lib, by = c("Row", "Column", "Plate #")) %>%
      arrange(`Plate #`, Column, Row) ## Ordering by Plate , Column and Row.
  }
```


```{r}
data_lib <- matrix_preparation(file_lib= "Data/Keyfile_YKO-PK_384_reformatted_DN.csv",
                               rows_plate = rows_plate, 
                                        columns_plate=columns_plate)
head(data_lib)
dim(data_lib)
```

```{r}
data_lib  %>% 
  group_by(Plate) %>% 
  tally()
```

```{r}
data_lib <-  data_lib %>% 
  select(Plate, rowname, New_column, ORF) %>% 
  rename("New_row" = "rowname",
         "New_plate" = "Plate") %>%
  mutate(New_plate = as.character(New_plate))
head(data_lib)
```

```{r}
data_lib_YKO <- merging_files(file_lib = "Data/MATa_YKO_v5.0_384.csv", data_gene = data_lib,
                              rows_plate = rows_plate, 
                              columns_plate = columns_plate)
dim(data_lib_YKO)
head(data_lib_YKO)
```

```{r}
data_lib_YKO %>% 
  filter(Old_plate == "4", Old_row == "C", Old_column == "1")
```

```{r}
# data_lib <- matrix_preparation(file_lib= "Data/tsMATaKeyFile-384.csv")
# 
# # Preparing the data library
# data_lib <-  data_lib %>% 
#   select(Plate, rowname, New_column, ORF) %>% 
#   rename("New_row" = "rowname",
#          "New_plate" = "Plate") %>%
#   mutate(New_plate = as.character(New_plate))
# 
# # Data frame with old and new Coordinates alongside with the others columns from key file.
# data_lib_TS <- merging_files(file_lib ="Data/tsMATaKeyFile-384.csv", data_gene = data_lib)
# head(data_lib_TS)
```

## Colony Areas

```{bash}
sed -i -e '$a\' colonyAreasA_test_YKO.txt 
```

Also to change the NS and SP

```{bash}
sed 's/CanFOA/SP/gi' Data/colonyAreasA_test_YKO.txt | sed 's/YPD/NSP/gi' > Data/colonyAreasA_test_YKO.txt
```


```{r}
## Read colony areas file
screen_data <- Colony_areas(filename = "Data/colonyAreas_HR.txt")
head(screen_data)
```
Step by step

```{r}
# filename <- "Data/colonyAreas_HR2.txt"
# # Read Colony File
# lines <- readLines(filename)
# 
# ## Parse and clean plate
# plates <- grep('[A-Za-z]', lines, value = TRUE)
# 
# ## Drop plate and parse measurements
# cm <- lines[-grep("[A-Za-z]", lines)]
# 
# tbl <- do.call(rbind, strsplit(cm, split = "\t"))
# 
# data_colony <- tbl %>% 
#   assign_names(c("size", "circ")) %>% 
#   as.data.frame(stringsAsFactors = FALSE) %>%
#   mutate(size = as.numeric(.data$size),
#          circ = as.numeric(.data$circ))
# 
# # Extract values
# nobs <- nrow(data_colony) #Number of Observations
# density <- nobs/length(plates) # Colonies for plate
```

```{r}
# data_colony %>% 
#   mutate(
#       id = rep(plates, length.out = nobs, each = density)
#     ) %>%
#     mutate(id = str_replace_all(id, '"\"', ''),
#            id = gsub('[\r\n\t]', '', id)) %>% 
#   separate(id, c("Plate", "replicate", NA), sep = ",") %>%
#   separate(Plate, c("plate_name", "trat"), sep = "_") %>%
#   head()
```

```{r}
# df_colony <- data_colony %>% 
#     mutate(
#       id = rep(plates, length.out = nobs, each = density)
#     ) %>%
#     mutate(id = str_replace_all(id, '"\"', ''),
#            id = gsub('[\r\n\t]', '', id)) %>%
#     separate(id, c("Plate", "replicate", NA), sep = ",") %>%
#     separate(Plate, c("plate_name", "trat"), sep = "_") %>% 
#     mutate(plate_name = gsub('\"', '', plate_name),
#            replicate = gsub('\"', '', replicate))

```

Change also the names

```{r}
x <- unique(screen_data$plate_name)
str_extract(x, "(\\d)+")
```

la columna que importa por el momento es `Trat` ya que es la  que contiene las condiciones.

```{r, eval=FALSE}
# data = screen_data
# df <- data %>% 
#   # filter(grepl(string = plate_name, pattern = screen_pattern)) %>% 
#   filter(grepl(pattern = screen_pattern, x = plate_name, ignore.case = TRUE)) %>% 
#   mutate(
#     plate_name = str_replace_all(plate_name, " ", ""),
#     Plate_number = str_replace_all(plate_name, letter, ""),
#     Plate_number = str_replace_all(Plate_number, regex(screen_pattern, ignore_case = TRUE), ""),
#     Plate_number = str_replace_all(Plate_number, '"', ''),
#     Plate_number = as.numeric(Plate_number)
#   ) %>% 
#   unite("Trat_code", trat, replicate, sep = "_") %>% 
#   select(-circ)
```


```{r}
YKO_data <- Screen_processing(data = screen_data)
head(YKO_data)
```


```{r}
data <- YKO_data
nrows <- data %>% 
    group_by(Trat_code) %>% 
    summarise(n = n()) %>% 
    filter(n == max(n)) %>%
    distinct(n) %>% 
    pull(n)
nrows
colony_col <- unique(data$Trat_code)
colony_col
nplates <- length(unique(data$Plate_number))
nplates
```

```{r}
data %>% 
  count(plate_name,Plate_number,Trat_code)
```

```{r}
for (t in 1:length(colony_col)){
  for (i in 1:14) {
    x <- data %>% 
      filter(Trat_code == colony_col[t], Plate_number == i) %>% 
      dim()
    print(paste("trat_code: ", t, " Plate_number: ", i, " Dim: ", x[1]))
  }
}
```


```{r}
colony_database <- matrix(nrow = nrows, ncol = length(colony_col))
  
  ## Filling Matrix
  for (t in 1:length(colony_col)) {
    replicate_data <- vector(mode = "numeric") # For each plate
    for (i in 1:nplates) {
      replicate <- data %>% 
        filter(Trat_code == colony_col[t], Plate_number == i) %>% 
        pull(size)
      if (length(replicate) == 0) {
        replicate <- rep(NA, 1536)
        replicate_data <- c(replicate_data, replicate)
      } else {
        replicate_data <- c(replicate_data, replicate)
      }
    }
    colony_database[,t] <- replicate_data
  }
```

```{r}
colnames(colony_database) <- colony_col
```

```{r}
head(colony_database)
```


As we have more generalized names we can change the next code

```{r, eval=FALSE}
  if (type_letter == "B") {
    df <- as.data.frame(colony_database) %>% 
      select(starts_with("URA"), CanFOA_1:CanFOA_6) 
  } else {
    df <- as.data.frame(colony_database) %>% 
      select(YPD_1:YPD_6, CanFOA_1:CanFOA_6)
  }
```


```{r}
df <- as.data.frame(colony_database) %>% 
  select(starts_with("NSP"), starts_with("SP"))
head(df)
```

With this we complete the first step for a general protocol.

Then we need to change the process for excel.

```{r}
cbind.fill <- function(...){
  # Credits: https://gist.github.com/abelsonlive/4112423
    nm <- list(...) 
    nm <- lapply(nm, as.matrix)
    n <- max(sapply(nm, nrow)) 
    do.call(cbind, lapply(nm, function (x) 
        rbind(x, matrix(,n-nrow(x), ncol(x))))) 
}
```

```{r}
database <- cbind.fill(data_lib_YKO, df) %>% 
  data.frame(stringsAsFactors = FALSE) %>% 
  mutate_at(vars(starts_with("NSP"), starts_with("SP")), as.numeric)
```

```{r DataColony_Filling}
#database <- cbind(data_lib_YKO, df)
head(database)
```
 Here will be changes as the columns are more general.
 
 Original
```{r, eval=FALSE}
raw_data <- database %>% 
  mutate(
      Gene = if_else(is.na(Gene) | Gene == "-", ORF, Gene)) %>% 
  rowwise() %>% 
  mutate(YPD_median = median(c(YPD_1,YPD_2,YPD_3,YPD_4,YPD_5,YPD_6), na.rm = TRUE),
             Median_50 = YPD_median*0.5,
             Median_20 = YPD_median*0.2,
             YPD_colonies = sum(c(YPD_1,YPD_2,YPD_3,YPD_4,YPD_5,YPD_6) > Median_50, na.rm = TRUE),
             CanFOA_colonies = sum(c(CanFOA_1,CanFOA_2,CanFOA_3,CanFOA_4,CanFOA_5,CanFOA_6) > Median_20, na.rm = TRUE),
             perc_GCR = CanFOA_colonies/YPD_colonies)
```

```{r}
test <- "Median_50"
raw_data <- database %>% 
  mutate(
    Gene = if_else(is.na(Gene) | Gene == "-", ORF, Gene)
  ) %>% 
  rowwise() %>% 
  mutate(
    Median_NSP = median(c_across(starts_with("NSP")), na.rm = TRUE),
    "Median_{n*100}" := Median_NSP*n,
    # Median_20 = Median_NSP*0.2,
    colonies_NSP = sum(c_across(starts_with("NSP")) > c_across(starts_with(test)), na.rm = TRUE),
    # colonies_SP = sum(c_across(starts_with("SP")) > Median_20, na.rm = TRUE),
    # perc_GCR = colonies_SP/colonies_NSP
  )
head(raw_data)
```


